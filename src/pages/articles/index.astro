---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allArticles = await getCollection('articles', ({ data }) => !data.archived);

// Learning path articles (sorted by pathStep)
const pathArticles = allArticles
  .filter(a => a.data.pathStep)
  .sort((a, b) => (a.data.pathStep || 0) - (b.data.pathStep || 0));

// Group by scene (for scene view)
const sceneMap = new Map<string, typeof allArticles>();
for (const article of allArticles) {
  const scene = article.data.scene;
  if (!sceneMap.has(scene)) sceneMap.set(scene, []);
  sceneMap.get(scene)!.push(article);
}

// Sort articles within each scene by order
for (const [, articles] of sceneMap) {
  articles.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
}

const sceneOrder = ['èªè­˜ OpenClaw', 'ç’°å¢ƒæº–å‚™', 'å®‰è£èˆ‡éƒ¨ç½²', 'åŸºç¤ä½¿ç”¨', 'æ ¸å¿ƒåŠŸèƒ½', 'æ•´åˆèˆ‡è‡ªå‹•åŒ–', 'çŸ¥è­˜èˆ‡é€²éš'];
const sceneIcons: Record<string, string> = {
  'èªè­˜ OpenClaw': 'ğŸ§­',
  'ç’°å¢ƒæº–å‚™': 'ğŸ”‘',
  'å®‰è£èˆ‡éƒ¨ç½²': 'ğŸ’»',
  'åŸºç¤ä½¿ç”¨': 'ğŸš€',
  'æ ¸å¿ƒåŠŸèƒ½': 'ğŸ§©',
  'æ•´åˆèˆ‡è‡ªå‹•åŒ–': 'âš¡',
  'çŸ¥è­˜èˆ‡é€²éš': 'ğŸ“š',
};

const steps = [
  { step: 1, icon: 'ğŸ§­', title: 'èªè­˜ OpenClaw' },
  { step: 2, icon: 'ğŸ§ ', title: 'é¸æ“‡ä½ çš„ AI å¤§è…¦' },
  { step: 3, icon: 'ğŸ”‘', title: 'ç”³è«‹ API Key' },
  { step: 4, icon: 'ğŸ’»', title: 'å®‰è£ OpenClaw' },
  { step: 5, icon: 'ğŸš€', title: 'ç¬¬ä¸€æ¬¡å•Ÿå‹•' },
  { step: 6, icon: 'âš¡', title: 'ç¬¬ä¸€å€‹ Skill' },
];

// Build step map for step metadata
const stepMap = new Map(steps.map(s => [s.step, s]));
---

<BaseLayout title="æ•™å­¸æ–‡ç« ">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-4">æ•™å­¸æ–‡ç« </h1>
    <p class="text-text-secondary mb-8">
      å¾ä½ çš„å•é¡Œå‡ºç™¼ï¼Œæ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆã€‚æ¯ç¯‡æ–‡ç« éƒ½æ˜¯å¯æ“ä½œçš„å¯¦æˆ°ç­†è¨˜ã€‚
    </p>

    <!-- Tab switcher -->
    <div class="article-tabs mb-10" id="article-tabs">
      <button class="article-tab active" data-tab="path" onclick="switchTab('path')">
        ğŸš€ å…¥é–€è·¯ç·š
      </button>
      <button class="article-tab" data-tab="scene" onclick="switchTab('scene')">
        ğŸ—‚ï¸ å ´æ™¯ç€è¦½
      </button>
    </div>

    <!-- Tab: å…¥é–€è·¯ç·š -->
    <div class="tab-content active" id="tab-path">
      <div class="space-y-3">
        {steps.map((s) => {
          const article = pathArticles.find(a => a.data.pathStep === s.step);
          const available = !!article;

          return available ? (
            <a
              href={`/articles/${article.id}`}
              class="block p-5 rounded-lg bg-surface-light hover:bg-surface-lighter border border-surface-lighter hover:border-brand/50 transition-all group"
            >
              <div class="flex items-center gap-4">
                <div class="learning-path-step-badge available">
                  <span class="text-lg">{s.icon}</span>
                  <span class="step-num">{s.step}</span>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class={`text-xs px-2 py-0.5 rounded-full ${
                      article.data.difficulty === 'å…¥é–€' ? 'bg-green-500/20 text-green-400' :
                      article.data.difficulty === 'ä¸­ç´š' ? 'bg-yellow-500/20 text-yellow-400' :
                      'bg-red-500/20 text-red-400'
                    }`}>
                      {article.data.difficulty}
                    </span>
                  </div>
                  <h3 class="font-medium group-hover:text-brand-light transition-colors">
                    {article.data.title}
                  </h3>
                  <p class="text-text-muted text-sm mt-1">{article.data.description}</p>
                </div>
                <span class="text-text-muted group-hover:text-brand-light transition-colors shrink-0">â†’</span>
              </div>
            </a>
          ) : (
            <div class="block p-5 rounded-lg bg-surface-light/50 border border-surface-lighter/50 opacity-60">
              <div class="flex items-center gap-4">
                <div class="learning-path-step-badge upcoming">
                  <span class="text-lg">{s.icon}</span>
                  <span class="step-num">{s.step}</span>
                </div>
                <div class="flex-1">
                  <h3 class="font-medium text-text-muted">{s.title}</h3>
                  <p class="text-text-muted text-sm mt-1">ğŸ“ å³å°‡æ¨å‡º</p>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Supplementary articles (not in main path) */}
      <div class="mt-12">
        <h2 class="text-lg font-semibold mb-4 text-text-secondary">ğŸ“– å»¶ä¼¸é–±è®€</h2>
        <div class="space-y-3">
          {allArticles
            .filter(a => !a.data.pathStep)
            .sort((a, b) => (a.data.order || 0) - (b.data.order || 0))
            .map((article) => (
              <a
                href={`/articles/${article.id}`}
                class="block p-4 rounded-lg bg-surface-light hover:bg-surface-lighter border border-surface-lighter hover:border-brand/50 transition-all group"
              >
                <div class="flex items-center justify-between gap-4">
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-xs px-2 py-0.5 rounded-full bg-brand/20 text-brand-light">
                        {article.data.scene}
                      </span>
                      <span class={`text-xs px-2 py-0.5 rounded-full ${
                        article.data.difficulty === 'å…¥é–€' ? 'bg-green-500/20 text-green-400' :
                        article.data.difficulty === 'ä¸­ç´š' ? 'bg-yellow-500/20 text-yellow-400' :
                        'bg-red-500/20 text-red-400'
                      }`}>
                        {article.data.difficulty}
                      </span>
                    </div>
                    <h3 class="font-medium group-hover:text-brand-light transition-colors">
                      {article.data.title}
                    </h3>
                    <p class="text-text-muted text-sm mt-1">{article.data.description}</p>
                  </div>
                  <span class="text-text-muted group-hover:text-brand-light transition-colors shrink-0">â†’</span>
                </div>
              </a>
            ))}
        </div>
      </div>
    </div>

    <!-- Tab: å ´æ™¯ç€è¦½ -->
    <div class="tab-content" id="tab-scene">
      {sceneOrder.map((sceneName) => {
        const articles = sceneMap.get(sceneName);
        if (!articles || articles.length === 0) return null;
        return (
          <section class="mb-12">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
              <span>{sceneIcons[sceneName] || 'ğŸ“„'}</span>
              {sceneName}
            </h2>
            <div class="space-y-3">
              {articles.map((article) => (
                <a
                  href={`/articles/${article.id}`}
                  class="block p-5 rounded-lg bg-surface-light hover:bg-surface-lighter border border-surface-lighter hover:border-brand/50 transition-all group"
                >
                  <div class="flex items-center justify-between gap-4">
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class={`text-xs px-2 py-0.5 rounded-full ${
                          article.data.difficulty === 'å…¥é–€' ? 'bg-green-500/20 text-green-400' :
                          article.data.difficulty === 'ä¸­ç´š' ? 'bg-yellow-500/20 text-yellow-400' :
                          'bg-red-500/20 text-red-400'
                        }`}>
                          {article.data.difficulty}
                        </span>
                        {article.data.pathStep && (
                          <span class="text-xs px-2 py-0.5 rounded-full bg-brand/20 text-brand-light">
                            å…¥é–€ç¬¬ {article.data.pathStep} æ­¥
                          </span>
                        )}
                      </div>
                      <h3 class="font-medium group-hover:text-brand-light transition-colors">
                        {article.data.title}
                      </h3>
                      <p class="text-text-muted text-sm mt-1">{article.data.description}</p>
                    </div>
                    <span class="text-text-muted group-hover:text-brand-light transition-colors shrink-0">â†’</span>
                  </div>
                </a>
              ))}
            </div>
          </section>
        );
      })}
    </div>

    {allArticles.length === 0 && (
      <div class="text-center py-20">
        <p class="text-4xl mb-4">ğŸš§</p>
        <p class="text-text-secondary">æ•™å­¸æ–‡ç« æ­£åœ¨æº–å‚™ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
        <a
          href="/#discussion"
          class="inline-block mt-4 text-brand-light hover:text-brand transition-colors"
        >
          å…ˆåˆ°è¨è«–å€èŠèŠï¼Ÿ
        </a>
      </div>
    )}
  </div>
</BaseLayout>

<script is:inline>
function switchTab(tab) {
  // Update tab buttons
  document.querySelectorAll('.article-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(el => {
    el.classList.toggle('active', el.id === 'tab-' + tab);
  });
  // Save preference
  localStorage.setItem('launchdock-article-tab', tab);
}

// Restore tab preference
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('launchdock-article-tab');
  if (saved) switchTab(saved);
});
</script>
